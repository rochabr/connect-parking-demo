<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Return from Stripe • Parking Checkout</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body class="return-page">
    <!-- Consistent header -->
    <header class="site-header">
      <div class="container header-inner">
        <a href="./index.html" class="brand">
          <img
            src="https://support-us.justpark.com/hc/theming_assets/01JDJABSECHJJ4C56H23Z3MD9Z"
            alt="JustPark Logo"
            class="brand-logo"
          />
        </a>
        <nav class="nav">
          <a class="nav-link" href="./index.html">Checkout</a>
          <a class="nav-link" href="./payments.html">Payments</a>
        </nav>
      </div>
    </header>

    <main class="container">
      <section class="section-card">
        <h2 class="section-step-title">
          <span class="step-number">Checkout Complete</span>
          <span class="step-label">Thanks for returning from Stripe</span>
        </h2>

        <p id="status" class="status-text muted">Checking session status…</p>

        <div id="details" class="session-details"></div>

        <p class="hint" style="text-align:center;">
          If this page looks stuck, open your browser console for errors.
        </p>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container">
        <div class="foot-left">© Demo • For testing only</div>
        <div class="foot-right">
          <span class="chip">Stripe Checkout</span>
          <span class="chip">Connect Demo</span>
        </div>
      </div>
    </footer>

    <noscript>
      <p class="status-err">JavaScript is disabled — enable it to see session details.</p>
    </noscript>

    <script>
      (function () {
        const API_HOST = 'http://localhost:4242';
        const statusEl = document.getElementById('status');
        const detailsEl = document.getElementById('details');

        function q(name) {
          const params = new URLSearchParams(location.search);
          return params.get(name);
        }

        const sessionId = q('session_id');
        if (!sessionId) {
          statusEl.outerHTML =
            '<span class="status-badge status-err">Error</span> Missing ?session_id in the URL.';
          return;
        }

        fetch(API_HOST + '/api/checkout/session/' + encodeURIComponent(sessionId))
          .then(async (r) => {
            if (!r.ok) throw new Error(await r.text() || 'Request failed');
            return r.json();
          })
          .then((data) => {
            const paid = data.payment_status === 'paid';
            const complete = data.status === 'complete';
            const badge = paid
              ? '<span class="status-badge status-ok">Payment succeeded</span>'
              : complete
              ? '<span class="status-badge status-warn">Session complete, unpaid</span>'
              : '<span class="status-badge status-err">Payment incomplete</span>';
            statusEl.innerHTML = badge;

            const amount = typeof data.amount_total === 'number'
              ? (data.amount_total / 100).toFixed(2) + ' ' + (data.currency || '').toUpperCase()
              : '—';

            detailsEl.innerHTML = `
              <ul>
                <li><strong>Session ID:</strong> ${data.id}</li>
                <li><strong>Amount Total:</strong> ${amount}</li>
                <li><strong>Customer:</strong> ${data.customer?.name || data.customer?.email || data.customer?.id || '—'}</li>
                <li><strong>Payment Intent:</strong> ${data.payment_intent?.id || '—'} (${data.payment_intent?.status || '—'})</li>
                <li><strong>Created (unix):</strong> ${data.created}</li>
              </ul>
              <details>
                <summary>Raw response</summary>
                <pre>${escapeHTML(JSON.stringify(data, null, 2))}</pre>
              </details>
              <p style="text-align:center; margin-top:20px;">
                <a href="./index.html">← Start another checkout</a>
              </p>
            `;
          })
          .catch((e) => {
            console.error(e);
            statusEl.innerHTML = '<span class="status-badge status-err">Error</span> Failed to load session.';
            detailsEl.innerHTML = `<pre>${escapeHTML(String(e))}</pre>`;
          });

        function escapeHTML(s) {
          return s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
        }
      })();
    </script>
  </body>
</html>
