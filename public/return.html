<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Return from Stripe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
      .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; max-width: 720px; }
      .muted { color: #666; }
      .ok { color: #0a7d0a; }
      .warn { color: #b75c00; }
      .err { color: #b00020; }
      pre { background: #f6f8fa; padding: 12px; border-radius: 6px; overflow: auto; }
      noscript { color: #b00020; font-weight: 600; }
    </style>
  </head>
  <body>
    <h1>Thanks for returning from Stripe</h1>

    <div class="card">
      <p id="status" class="muted">Checking session status…</p>
      <div id="details"></div>
      <p class="muted">If this page looks stuck, open your browser console for errors.</p>
    </div>

    <noscript>JavaScript is disabled—enable it to see the session details.</noscript>

    <script>
      (function () {
        const API_HOST = 'http://localhost:4242';
        const statusEl = document.getElementById('status');
        const detailsEl = document.getElementById('details');

        function q(name) {
          const params = new URLSearchParams(location.search);
          return params.get(name);
        }

        const sessionId = q('session_id');
        if (!sessionId) {
          statusEl.className = 'err';
          statusEl.textContent = 'Missing ?session_id in the URL.';
          return;
        }

        fetch(API_HOST + '/api/checkout/session/' + encodeURIComponent(sessionId))
          .then(async (r) => {
            if (!r.ok) {
              const t = await r.text();
              throw new Error(t || 'Request failed');
            }
            return r.json();
          })
          .then((data) => {
            const paid = data.payment_status === 'paid';
            statusEl.className = paid ? 'ok' : (data.status === 'complete' ? 'ok' : 'warn');
            statusEl.textContent = paid
              ? 'Payment succeeded.'
              : `Session status: ${data.status}, payment_status: ${data.payment_status}`;

            const amount = typeof data.amount_total === 'number'
              ? (data.amount_total / 100).toFixed(2) + ' ' + (data.currency || '').toUpperCase()
              : '—';

            detailsEl.innerHTML = `
              <ul>
                <li><strong>Session ID:</strong> ${data.id}</li>
                <li><strong>Amount Total:</strong> ${amount}</li>
                <li><strong>Customer:</strong> ${data.customer?.name || data.customer?.email || data.customer?.id || '—'}</li>
                <li><strong>Payment Intent:</strong> ${data.payment_intent?.id || '—'} (${data.payment_intent?.status || '—'})</li>
                <li><strong>Created (unix):</strong> ${data.created}</li>
              </ul>
              <details>
                <summary>Raw response</summary>
                <pre>${escapeHTML(JSON.stringify(data, null, 2))}</pre>
              </details>
              <p><a href="./index.html">Start another checkout</a></p>
            `;
          })
          .catch((e) => {
            console.error(e);
            statusEl.className = 'err';
            statusEl.textContent = 'Failed to load session. See console.';
            detailsEl.innerHTML = `<pre>${escapeHTML(String(e))}</pre>`;
          });

        function escapeHTML(s) {
          return s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
        }
      })();
    </script>
  </body>
</html>
